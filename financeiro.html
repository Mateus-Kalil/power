<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WOLFINANCE</title>

    <link rel="icon" href="favicon2.png" type="image/x-icon" />
    <link rel="shortcut icon" href="favicon2.png" type="image/x-icon" />
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #00f2ff;
            --secondary: #000000;
            --accent: #ffea00;
            --dark: #0a0a0f;
            --darker: #050508;
            --glass: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text: #ffffff;
            --text-dim: rgba(255, 255, 255, 0.7);
            --success: #00ff88;
            --danger: #ff0055;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--darker);
            color: var(--text);
            overflow-x: hidden;
            min-height: 100vh;
            position: relative;
        }

        .bg-animated {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -3;
            background: linear-gradient(135deg, #0a0a0f 0%, #000000 50%, #0a0a0f 100%);
            pointer-events: none;
        }

        .bg-animated::before {
            content: '';
            position: absolute;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle at 20% 50%, rgba(0, 242, 255, 0.1) 0%, transparent 50%),
                        radial-gradient(circle at 80% 80%, rgba(0, 0, 0, 0.1) 0%, transparent 50%),
                        radial-gradient(circle at 40% 20%, rgba(255, 234, 0, 0.05) 0%, transparent 50%);
            pointer-events: none;
        }

        canvas#particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -2;
            pointer-events: none;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }

        header {
            background: var(--glass);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 20px 30px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
            animation: slideDown 0.6s ease-out;
            position: relative;
            z-index: 10;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .logo {
            font-size: 28px;
            font-weight: 800;
            background: linear-gradient(135deg, #0080ff, #000000);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -1px;
        }

        nav {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .nav-btn {
            background: var(--glass);
            border: 1px solid var(--glass-border);
            color: var(--text);
            padding: 12px 24px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            z-index: 10;
        }

        .nav-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
            z-index: -1;
        }

        .nav-btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .nav-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0, 242, 255, 0.3);
            border-color: var(--primary);
        }

        .nav-btn.active {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-color: transparent;
            box-shadow: 0 5px 20px rgba(0, 242, 255, 0.5);
        }

        .section {
            display: none;
            animation: fadeIn 0.5s ease-out;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .glass-card {
            background: var(--glass);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            z-index: 1;
        }

        .glass-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(0, 242, 255, 0.1) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }

        .glass-card:hover::before {
            opacity: 1;
        }

        .glass-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 60px rgba(0, 242, 255, 0.2);
            border-color: rgba(0, 242, 255, 0.3);
        }

        h2 {
            font-size: 32px;
            font-weight: 800;
            margin-bottom: 20px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        h3 {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 15px;
            color: var(--text);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--glass);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 24px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            transform: scaleX(0);
            transition: transform 0.3s ease;
            transform-origin: left;
        }

        .stat-card:hover::after {
            transform: scaleX(1);
        }

        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(0, 242, 255, 0.2);
        }

        .stat-label {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-dim);
            margin-bottom: 8px;
            font-weight: 600;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 800;
            color: var(--text);
            margin-bottom: 4px;
        }

        .stat-change {
            font-size: 14px;
            font-weight: 600;
        }

        .stat-change.positive {
            color: var(--success);
        }

        .stat-change.negative {
            color: var(--danger);
        }

        .btn {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: var(--dark);
            border: none;
            padding: 14px 28px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            z-index: 10;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0, 242, 255, 0.5);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: var(--glass);
            color: var(--text);
            border: 1px solid var(--glass-border);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #cc0044);
        }

        input, select, textarea {
            width: 100%;
            background: rgba(0, 128, 255, 0.05);
            border: 1px solid rgba(0, 128, 255, 0.3);
            border-radius: 12px;
            padding: 14px 18px;
            color: #0080ff;
            font-size: 14px;
            font-family: 'Inter', sans-serif;
            transition: all 0.3s ease;
            margin-bottom: 15px;
            position: relative;
            z-index: 10;
        }

        input::placeholder, textarea::placeholder {
            color: rgba(0, 128, 255, 0.5);
        }

        select option {
            background: #0a0a0f;
            color: #0080ff;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #0080ff;
            box-shadow: 0 0 0 3px rgba(0, 128, 255, 0.2);
            background: rgba(0, 128, 255, 0.08);
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th {
            background: rgba(0, 242, 255, 0.1);
            padding: 16px;
            text-align: left;
            font-weight: 700;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 2px solid var(--primary);
        }

        td {
            padding: 16px;
            border-bottom: 1px solid var(--glass-border);
            font-size: 14px;
        }

        tr {
            transition: all 0.2s ease;
        }

        tr:hover {
            background: rgba(0, 242, 255, 0.05);
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--glass);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 16px 24px;
            color: var(--text);
            font-weight: 600;
            z-index: 1000;
            animation: slideInRight 0.3s ease-out;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            max-width: 400px;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .toast.success {
            border-left: 4px solid var(--success);
        }

        .toast.error {
            border-left: 4px solid var(--danger);
        }

        .toast.info {
            border-left: 4px solid var(--primary);
        }

        .loader {
            border: 3px solid var(--glass);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
        }

        .portfolio-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .portfolio-selector select {
            flex: 1;
            min-width: 200px;
            margin: 0;
        }

        .delete-btn {
            background: transparent;
            color: var(--danger);
            border: 1px solid var(--danger);
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
            position: relative;
            z-index: 100;
            pointer-events: auto;
        }

        .delete-btn:hover {
            background: var(--danger);
            color: var(--dark);
            transform: scale(1.05);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 999;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease-out;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--dark);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 40px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            animation: scaleIn 0.3s ease-out;
            box-shadow: 0 20px 60px rgba(0, 242, 255, 0.3);
        }

        @keyframes scaleIn {
            from {
                transform: scale(0.9);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .close-modal {
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: var(--text-dim);
            transition: all 0.2s ease;
            line-height: 1;
        }

        .close-modal:hover {
            color: var(--danger);
            transform: rotate(90deg);
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            header {
                padding: 15px 20px;
            }

            .logo {
                font-size: 24px;
            }

            nav {
                width: 100%;
            }

            .nav-btn {
                flex: 1;
                min-width: calc(50% - 5px);
                padding: 10px 16px;
                font-size: 12px;
            }

            .glass-card {
                padding: 20px;
            }

            h2 {
                font-size: 24px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            table {
                font-size: 12px;
            }

            th, td {
                padding: 10px 8px;
            }

            .toast {
                right: 10px;
                left: 10px;
                max-width: none;
            }
        }

        .glow-text {
            text-shadow: 0 0 10px currentColor, 0 0 20px currentColor;
        }

        .neon-border {
            box-shadow: 0 0 5px var(--primary), 0 0 10px var(--primary), 0 0 15px var(--primary);
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--glass);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            transition: width 0.5s ease;
            border-radius: 4px;
        }

        .asset-type-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .asset-type-badge.crypto {
            background: rgba(255, 234, 0, 0.2);
            color: var(--accent);
            border: 1px solid var(--accent);
        }

        .asset-type-badge.cdi {
            background: rgba(0, 242, 255, 0.2);
            color: var(--primary);
            border: 1px solid var(--primary);
        }

        .asset-type-badge.fixed {
            background: rgba(0, 255, 136, 0.2);
            color: var(--success);
            border: 1px solid var(--success);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-dim);
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .grid-2 {
                grid-template-columns: 1fr;
            }
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .refresh-btn {
            background: var(--glass);
            border: 1px solid var(--glass-border);
            color: var(--primary);
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .refresh-btn:hover {
            background: var(--primary);
            color: var(--dark);
            transform: rotate(180deg);
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }

        .file-input-label {
            display: block;
            background: var(--glass);
            border: 2px dashed var(--glass-border);
            color: var(--text);
            padding: 20px;
            text-align: center;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-input-label:hover {
            border-color: var(--primary);
            background: rgba(0, 242, 255, 0.05);
        }

        .calculator-result {
            background: rgba(0, 242, 255, 0.1);
            border: 1px solid var(--primary);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }

        .result-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid var(--glass-border);
        }

        .result-row:last-child {
            border-bottom: none;
        }

        .result-label {
            font-weight: 600;
            color: var(--text-dim);
        }

        .result-value {
            font-weight: 800;
            color: var(--primary);
            font-size: 18px;
        }

        input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--primary);
        }
    </style>
</head>
<body>
    <div class="bg-animated"></div>
    <canvas id="particles"></canvas>

    <div class="container">
        <header>
            <div class="logo">WOLFINANCE</div>
            <nav>
                <button class="nav-btn active" onclick="showSection('dashboard')">Dashboard</button>
                <button class="nav-btn" onclick="showSection('prices')">Preços</button>
                <button class="nav-btn" onclick="showSection('portfolio')">Carteira</button>
                <button class="nav-btn" onclick="showSection('calculator')">Calculadoras</button>
                <button class="nav-btn" onclick="showSection('settings')">Configurações</button>
            </nav>
        </header>

        <section id="dashboard" class="section active">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; margin-bottom: 20px;">
                <h2 style="margin: 0;">Dashboard</h2>
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; background: var(--glass); padding: 10px 16px; border-radius: 12px; border: 1px solid var(--glass-border);">
                    <input type="checkbox" id="adjust-inflation-dashboard" onchange="syncInflationCheckbox('dashboard')" style="margin: 0;">
                    <span style="font-size: 14px; font-weight: 600; color: var(--text); text-transform: none;">Ajustar pela Inflação (IPCA)</span>
                </label>
            </div>
            
            <div id="inflation-indicator" style="display: none; background: rgba(255, 234, 0, 0.1); border: 1px solid var(--accent); border-radius: 12px; padding: 15px; margin-bottom: 20px;">
                <p style="margin: 0; color: var(--accent); font-weight: 600; font-size: 14px;">
                    ⚠️ Valores ajustados pela inflação (IPCA) | Média 25 anos: <span id="ipca-avg-display">5.8%</span> a.a. | Valores em poder de compra de hoje
                </p>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Total Investido</div>
                    <div class="stat-value" id="total-invested">R$ 0,00</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Valor Atual</div>
                    <div class="stat-value" id="current-value">R$ 0,00</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Lucro/Prejuízo</div>
                    <div class="stat-value" id="total-pl">R$ 0,00</div>
                    <div class="stat-change" id="total-pl-percent">0%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Ativos</div>
                    <div class="stat-value" id="total-assets">0</div>
                </div>
            </div>

            <div class="grid-2">
                <div class="glass-card">
                    <div class="card-header">
                        <h3>Alocação por Classe</h3>
                        <button class="refresh-btn" onclick="updateDashboard()">↻</button>
                    </div>
                    <div class="chart-container">
                        <canvas id="allocation-chart"></canvas>
                    </div>
                </div>

                <div class="glass-card">
                    <h3>Evolução do Patrimônio</h3>
                    <div class="chart-container">
                        <canvas id="evolution-chart"></canvas>
                    </div>
                </div>
            </div>

            <div class="glass-card">
                <h3>Resumo da Carteira Ativa</h3>
                <div id="dashboard-portfolio-name" style="color: var(--primary); font-size: 18px; margin-bottom: 15px;"></div>
                <div id="dashboard-holdings"></div>
            </div>
        </section>

        <section id="prices" class="section">
            <h2>Preços em Tempo Real</h2>
            
            <div class="glass-card">
                <div class="card-header">
                    <h3>Índices Globais</h3>
                    <button class="refresh-btn" onclick="updatePrices()">↻</button>
                </div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">S&P 500</div>
                        <div class="stat-value" id="sp500-value">Carregando...</div>
                        <div class="stat-change" id="sp500-change">--</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">NASDAQ</div>
                        <div class="stat-value" id="nasdaq-value">Carregando...</div>
                        <div class="stat-change" id="nasdaq-change">--</div>
                    </div>
                </div>
            </div>

            <div class="glass-card">
                <div class="card-header">
                    <h3>Índices Brasil</h3>
                    <button class="refresh-btn" onclick="updatePrices()">↻</button>
                </div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Ibovespa</div>
                        <div class="stat-value" id="ibov-value">Carregando...</div>
                        <div class="stat-change" id="ibov-change">--</div>
                    </div>
                </div>
            </div>

            <div class="glass-card">
                <div class="card-header">
                    <h3>Câmbio</h3>
                    <button class="refresh-btn" onclick="updatePrices()">↻</button>
                </div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Dólar Americano (USD)</div>
                        <div class="stat-value" id="usd-brl-value">Carregando...</div>
                        <div class="stat-change" id="usd-brl-change">--</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Euro (EUR)</div>
                        <div class="stat-value" id="eur-brl-value">Carregando...</div>
                        <div class="stat-change" id="eur-brl-change">--</div>
                    </div>
                </div>
            </div>

            <div class="glass-card">
                <div class="card-header">
                    <h3>Indicadores Econômicos Brasil</h3>
                    <button class="refresh-btn" onclick="updatePrices()">↻</button>
                </div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Taxa Selic</div>
                        <div class="stat-value" id="selic-rate">Carregando...</div>
                        <div class="stat-change">% ao ano</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Taxa CDI</div>
                        <div class="stat-value" id="cdi-rate">Carregando...</div>
                        <div class="stat-change">% ao ano</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">IPCA</div>
                        <div class="stat-value" id="ipca-rate">Carregando...</div>
                        <div class="stat-change">% 12 meses</div>
                    </div>
                </div>
            </div>

            <div class="glass-card">
                <div class="card-header">
                    <h3>Tesouro Direto</h3>
                    <button class="refresh-btn" onclick="updatePrices()">↻</button>
                </div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Tesouro Selic 2027</div>
                        <div class="stat-value" id="tesouro-selic-value">Carregando...</div>
                        <div class="stat-change" id="tesouro-selic-rate">--</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Tesouro IPCA+ 2029</div>
                        <div class="stat-value" id="tesouro-ipca-value">Carregando...</div>
                        <div class="stat-change" id="tesouro-ipca-rate">--</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Tesouro Prefixado 2027</div>
                        <div class="stat-value" id="tesouro-prefixado-value">Carregando...</div>
                        <div class="stat-change" id="tesouro-prefixado-rate">--</div>
                    </div>
                </div>
            </div>

            <div class="glass-card">
                <div class="card-header">
                    <h3>Fundos Imobiliários (FIIs)</h3>
                    <button class="refresh-btn" onclick="updatePrices()">↻</button>
                </div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">MXRF11</div>
                        <div class="stat-value" id="price-mxrf11">Carregando...</div>
                        <div class="stat-change" id="change-mxrf11">--</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">HGRE11</div>
                        <div class="stat-value" id="price-hgre11">Carregando...</div>
                        <div class="stat-change" id="change-hgre11">--</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">BTLG11</div>
                        <div class="stat-value" id="price-btlg11">Carregando...</div>
                        <div class="stat-change" id="change-btlg11">--</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">VISC11</div>
                        <div class="stat-value" id="price-visc11">Carregando...</div>
                        <div class="stat-change" id="change-visc11">--</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">KNRI11</div>
                        <div class="stat-value" id="price-knri11">Carregando...</div>
                        <div class="stat-change" id="change-knri11">--</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">XPML11</div>
                        <div class="stat-value" id="price-xpml11">Carregando...</div>
                        <div class="stat-change" id="change-xpml11">--</div>
                    </div>
                </div>
            </div>

            <div class="glass-card">
                <div class="card-header">
                    <h3>Criptomoedas</h3>
                    <button class="refresh-btn" onclick="updatePrices()">↻</button>
                </div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Bitcoin (BTC)</div>
                        <div class="stat-value" id="price-bitcoin">Carregando...</div>
                        <div class="stat-change" id="change-bitcoin">--</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Ethereum (ETH)</div>
                        <div class="stat-value" id="price-ethereum">Carregando...</div>
                        <div class="stat-change" id="change-ethereum">--</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Solana (SOL)</div>
                        <div class="stat-value" id="price-solana">Carregando...</div>
                        <div class="stat-change" id="change-solana">--</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Binance Coin (BNB)</div>
                        <div class="stat-value" id="price-binancecoin">Carregando...</div>
                        <div class="stat-change" id="change-binancecoin">--</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Cardano (ADA)</div>
                        <div class="stat-value" id="price-cardano">Carregando...</div>
                        <div class="stat-change" id="change-cardano">--</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">XRP (XRP)</div>
                        <div class="stat-value" id="price-ripple">Carregando...</div>
                        <div class="stat-change" id="change-ripple">--</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Dogecoin (DOGE)</div>
                        <div class="stat-value" id="price-dogecoin">Carregando...</div>
                        <div class="stat-change" id="change-dogecoin">--</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Polkadot (DOT)</div>
                        <div class="stat-value" id="price-polkadot">Carregando...</div>
                        <div class="stat-change" id="change-polkadot">--</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Avalanche (AVAX)</div>
                        <div class="stat-value" id="price-avalanche-2">Carregando...</div>
                        <div class="stat-change" id="change-avalanche-2">--</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Chainlink (LINK)</div>
                        <div class="stat-value" id="price-chainlink">Carregando...</div>
                        <div class="stat-change" id="change-chainlink">--</div>
                    </div>
                </div>
            </div>
        </section>

        <section id="portfolio" class="section">
            <h2>Gerenciar Carteira</h2>

            <div class="glass-card">
                <h3>Selecionar Carteira</h3>
                <div class="portfolio-selector">
                    <select id="portfolio-select" onchange="switchPortfolio()"></select>
                    <button class="btn" onclick="showCreatePortfolioModal()">+ Nova Carteira</button>
                </div>
            </div>

            <div class="glass-card">
                <h3>Adicionar Investimento</h3>
                <div class="form-grid">
                    <div class="input-group">
                        <label>Tipo de Ativo</label>
                        <select id="asset-type" onchange="toggleAssetFields()">
                            <option value="crypto">Criptomoeda</option>
                            <option value="cdi">CDI (Pós-fixado)</option>
                            <option value="fixed">Renda Fixa Prefixada</option>
                            <option value="fii">Fundo Imobiliário (FII)</option>
                            <option value="tesouro-selic">Tesouro Selic</option>
                            <option value="tesouro-ipca">Tesouro IPCA+</option>
                            <option value="tesouro-prefixado">Tesouro Prefixado</option>
                            <option value="stock">Ações</option>
                        </select>
                    </div>
                    <div class="input-group" id="crypto-field">
                        <label>Criptomoeda</label>
                        <select id="crypto-symbol">
                            <option value="bitcoin">Bitcoin (BTC)</option>
                            <option value="ethereum">Ethereum (ETH)</option>
                            <option value="solana">Solana (SOL)</option>
                            <option value="binancecoin">Binance Coin (BNB)</option>
                            <option value="cardano">Cardano (ADA)</option>
                            <option value="ripple">XRP (XRP)</option>
                            <option value="dogecoin">Dogecoin (DOGE)</option>
                            <option value="polkadot">Polkadot (DOT)</option>
                            <option value="avalanche-2">Avalanche (AVAX)</option>
                            <option value="chainlink">Chainlink (LINK)</option>
                        </select>
                    </div>
                    <div class="input-group" id="fii-field" style="display: none;">
                        <label>Ticker do FII</label>
                        <input type="text" id="fii-ticker" placeholder="Ex: MXRF11" style="text-transform: uppercase;">
                    </div>
                    <div class="input-group" id="stock-field" style="display: none;">
                        <label>Ticker da Ação</label>
                        <input type="text" id="stock-ticker" placeholder="Ex: PETR4" style="text-transform: uppercase;">
                    </div>
                    <div class="input-group" id="asset-name-field" style="display: none;">
                        <label>Nome do Ativo</label>
                        <input type="text" id="asset-name" placeholder="Ex: Tesouro Selic 2027">
                    </div>
                </div>

                <div class="form-grid">
                    <div class="input-group">
                        <label>Data do Aporte</label>
                        <input type="date" id="investment-date" required>
                    </div>
                    <div class="input-group" id="amount-field">
                        <label>Valor Investido (R$)</label>
                        <input type="number" id="investment-amount" step="0.01" placeholder="0.00" required>
                    </div>
                    <div class="input-group" id="quantity-field" style="display: none;">
                        <label>Quantidade</label>
                        <input type="number" id="crypto-quantity" step="0.00000001" placeholder="0.00">
                    </div>
                    <div class="input-group" id="rate-field" style="display: none;">
                        <label id="rate-label">Taxa Anual (%)</label>
                        <input type="number" id="interest-rate" step="0.01" placeholder="0.00">
                    </div>
                </div>

                <div class="input-group">
                    <label>Observações</label>
                    <textarea id="investment-notes" rows="3" placeholder="Adicione observações sobre este investimento..."></textarea>
                </div>

                <button class="btn" onclick="addInvestment()">Adicionar Investimento</button>
            </div>

            <div class="glass-card">
                <div class="card-header">
                    <h3>Meus Investimentos</h3>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <label style="display: flex; align-items: center; gap: 8px; margin: 0; cursor: pointer; text-transform: none;">
                            <input type="checkbox" id="adjust-inflation" onchange="toggleInflationAdjustment()" style="width: auto; margin: 0; cursor: pointer;">
                            <span style="font-size: 14px; font-weight: 600; color: var(--text);">Ajustar pela Inflação (IPCA)</span>
                        </label>
                    </div>
                </div>
                <div id="holdings-table"></div>
            </div>
        </section>

        <section id="calculator" class="section">
            <h2>Calculadora de Juros Compostos</h2>

            <div class="glass-card">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; margin-bottom: 20px;">
                    <h3 style="margin: 0;">Parâmetros</h3>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; background: var(--glass); padding: 8px 14px; border-radius: 10px; border: 1px solid var(--glass-border); margin: 0;">
                        <input type="checkbox" id="adjust-inflation-calculator" style="margin: 0;">
                        <span style="font-size: 13px; font-weight: 600; color: var(--text); text-transform: none;">Ajustar pela Inflação</span>
                    </label>
                </div>
                <div class="form-grid">
                    <div class="input-group">
                        <label>Capital Inicial (R$)</label>
                        <input type="number" id="calc-principal" step="0.01" placeholder="10000.00">
                    </div>
                    <div class="input-group">
                        <label>Aporte Mensal (R$)</label>
                        <input type="number" id="calc-monthly" step="0.01" placeholder="500.00">
                    </div>
                    <div class="input-group">
                        <label>Taxa Anual (%)</label>
                        <input type="number" id="calc-rate" step="0.01" placeholder="10.00">
                    </div>
                    <div class="input-group">
                        <label>Período (Meses)</label>
                        <input type="number" id="calc-months" placeholder="120">
                    </div>
                    <div class="input-group">
                        <label>Capitalização</label>
                        <select id="calc-compound">
                            <option value="monthly">Mensal</option>
                            <option value="daily">Diária</option>
                        </select>
                    </div>
                </div>
                <button class="btn" onclick="calculateCompound()">Calcular</button>

                <div id="calculator-result" style="display: none;">
                    <div class="calculator-result">
                        <div class="result-row">
                            <span class="result-label">Total Investido:</span>
                            <span class="result-value" id="calc-total-invested">R$ 0,00</span>
                        </div>
                        <div class="result-row">
                            <span class="result-label">Juros Acumulados:</span>
                            <span class="result-value" id="calc-interest">R$ 0,00</span>
                        </div>
                        <div class="result-row">
                            <span class="result-label">Montante Final:</span>
                            <span class="result-value" id="calc-final">R$ 0,00</span>
                        </div>
                        <div class="result-row">
                            <span class="result-label">Rentabilidade:</span>
                            <span class="result-value" id="calc-return">0%</span>
                        </div>
                    </div>

                    <div class="chart-container">
                        <canvas id="calculator-chart"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <section id="settings" class="section">
            <h2>Configurações</h2>

            <div class="glass-card">
                <h3>Exportar Carteira</h3>
                <p style="color: var(--text-dim); margin-bottom: 15px;">Faça backup da sua carteira em formato JSON</p>
                <button class="btn" onclick="exportPortfolio()">Exportar Carteira Atual</button>
            </div>

            <div class="glass-card">
                <h3>Importar Carteira</h3>
                <p style="color: var(--text-dim); margin-bottom: 15px;">Restaure uma carteira a partir de um arquivo JSON</p>
                <div class="file-input-wrapper">
                    <input type="file" id="import-file" accept=".json" onchange="importPortfolio(event)">
                    <label for="import-file" class="file-input-label">
                        Clique para selecionar arquivo JSON
                    </label>
                </div>
            </div>

            <div class="glass-card">
                <h3>Resetar Carteira</h3>
                <p style="color: var(--text-dim); margin-bottom: 15px;">Remove todos os investimentos da carteira ativa (não pode ser desfeito)</p>
                <button class="btn btn-danger" onclick="confirmReset()">Resetar Carteira Ativa</button>
            </div>

            <div class="glass-card">
                <h3>Limpar Todos os Dados</h3>
                <p style="color: var(--text-dim); margin-bottom: 15px;">Remove TODAS as carteiras e dados (não pode ser desfeito)</p>
                <button class="btn btn-danger" onclick="confirmClearAll()">Limpar Tudo</button>
            </div>
        </section>

        <footer style="text-align: center; padding: 40px 20px; margin-top: 60px; border-top: 1px solid var(--glass-border);">
            <p style="color: var(--text-dim); font-size: 14px; margin-bottom: 8px;">
                &copy; 2026 WolfGuard. Todos os direitos reservados.
            </p>
            <p style="color: var(--text-dim); font-size: 12px;">
                WOLFINANCE - Plataforma de Análise Financeira Profissional
            </p>
        </footer>
    </div>

    <div id="create-portfolio-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeCreatePortfolioModal()">&times;</span>
            <h3>Criar Nova Carteira</h3>
            <div class="input-group">
                <label>Nome da Carteira</label>
                <input type="text" id="new-portfolio-name" placeholder="Ex: Minha Carteira 2026">
            </div>
            <button class="btn" onclick="createPortfolio()">Criar Carteira</button>
        </div>
    </div>

    <script>
        let state = {
            portfolios: [],
            activePortfolio: null,
            rates: {
                cdi: 10.65,
                selic: 10.75,
                ipca: 4.5,
                ipcaAvg25Years: 5.8
            },
            cryptoPrices: {},
            stockPrices: {},
            ipcaHistory: [],
            inflationAdjusted: false,
            charts: {}
        };

        function initParticles() {
            const canvas = document.getElementById('particles');
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;

            const particles = [];
            const particleCount = 50;

            for (let i = 0; i < particleCount; i++) {
                particles.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height,
                    vx: (Math.random() - 0.5) * 0.5,
                    vy: (Math.random() - 0.5) * 0.5,
                    radius: Math.random() * 2
                });
            }

            function animate() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = 'rgba(0, 242, 255, 0.5)';
                ctx.strokeStyle = 'rgba(0, 242, 255, 0.2)';

                particles.forEach((p, i) => {
                    p.x += p.vx;
                    p.y += p.vy;

                    if (p.x < 0 || p.x > canvas.width) p.vx *= -1;
                    if (p.y < 0 || p.y > canvas.height) p.vy *= -1;

                    ctx.beginPath();
                    ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
                    ctx.fill();

                    particles.forEach((p2, j) => {
                        if (i !== j) {
                            const dx = p.x - p2.x;
                            const dy = p.y - p2.y;
                            const dist = Math.sqrt(dx * dx + dy * dy);
                            if (dist < 100) {
                                ctx.beginPath();
                                ctx.moveTo(p.x, p.y);
                                ctx.lineTo(p2.x, p2.y);
                                ctx.stroke();
                            }
                        }
                    });
                });

                requestAnimationFrame(animate);
            }

            animate();

            window.addEventListener('resize', () => {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            });
        }

        function initParticles() {
            const canvas = document.getElementById('particles');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;

            const particles = [];
            const particleCount = 50;

            for (let i = 0; i < particleCount; i++) {
                particles.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height,
                    vx: (Math.random() - 0.5) * 0.5,
                    vy: (Math.random() - 0.5) * 0.5,
                    radius: Math.random() * 2
                });
            }

            function animate() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = 'rgba(0, 242, 255, 0.5)';
                ctx.strokeStyle = 'rgba(0, 242, 255, 0.2)';

                particles.forEach((p, i) => {
                    p.x += p.vx;
                    p.y += p.vy;

                    if (p.x < 0 || p.x > canvas.width) p.vx *= -1;
                    if (p.y < 0 || p.y > canvas.height) p.vy *= -1;

                    ctx.beginPath();
                    ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
                    ctx.fill();

                    particles.forEach((p2, j) => {
                        if (i !== j) {
                            const dx = p.x - p2.x;
                            const dy = p.y - p2.y;
                            const dist = Math.sqrt(dx * dx + dy * dy);
                            if (dist < 100) {
                                ctx.beginPath();
                                ctx.moveTo(p.x, p.y);
                                ctx.lineTo(p2.x, p2.y);
                                ctx.stroke();
                            }
                        }
                    });
                });

                requestAnimationFrame(animate);
            }

            animate();

            window.addEventListener('resize', () => {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            });
        }

        function showSection(section) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(section).classList.add('active');
            event.target.classList.add('active');

            if (section === 'dashboard') updateDashboard();
            if (section === 'portfolio') renderHoldings();
            if (section === 'prices') updatePrices();
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(value);
        }

        function formatPercent(value) {
            return value.toFixed(2) + '%';
        }

        function loadData() {
            const saved = localStorage.getItem('wolfinance');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    state.portfolios = data.portfolios || [];
                    state.activePortfolio = data.activePortfolio || null;
                    
                    if (!state.activePortfolio && state.portfolios.length > 0) {
                        state.activePortfolio = state.portfolios[0].id;
                    }
                } catch (e) {
                    console.error('Erro ao carregar dados:', e);
                }
            }

            if (state.portfolios.length === 0) {
                const defaultPortfolio = {
                    id: Date.now().toString(),
                    name: 'Minha Carteira Principal',
                    holdings: [],
                    history: []
                };
                state.portfolios.push(defaultPortfolio);
                state.activePortfolio = defaultPortfolio.id;
                saveData();
            }
        }

        function saveData() {
            localStorage.setItem('wolfinance', JSON.stringify({
                portfolios: state.portfolios,
                activePortfolio: state.activePortfolio
            }));
        }

        function getActivePortfolio() {
            return state.portfolios.find(p => p.id === state.activePortfolio);
        }

        function showCreatePortfolioModal() {
            document.getElementById('create-portfolio-modal').classList.add('active');
            document.getElementById('new-portfolio-name').value = '';
        }

        function closeCreatePortfolioModal() {
            document.getElementById('create-portfolio-modal').classList.remove('active');
        }

        function createPortfolio() {
            const name = document.getElementById('new-portfolio-name').value.trim();
            if (!name) {
                showToast('Digite um nome para a carteira', 'error');
                return;
            }

            const portfolio = {
                id: Date.now().toString(),
                name: name,
                holdings: [],
                history: []
            };

            state.portfolios.push(portfolio);
            state.activePortfolio = portfolio.id;
            saveData();
            updatePortfolioSelector();
            closeCreatePortfolioModal();
            showToast(`Carteira "${name}" criada com sucesso!`, 'success');
        }

        function updatePortfolioSelector() {
            const select = document.getElementById('portfolio-select');
            select.innerHTML = '';
            state.portfolios.forEach(p => {
                const option = document.createElement('option');
                option.value = p.id;
                option.textContent = p.name;
                option.selected = p.id === state.activePortfolio;
                select.appendChild(option);
            });
        }

        function switchPortfolio() {
            const select = document.getElementById('portfolio-select');
            state.activePortfolio = select.value;
            saveData();
            showToast('Carteira alterada!', 'info');
            updateDashboard();
            renderHoldings();
        }

        function toggleAssetFields() {
            const type = document.getElementById('asset-type').value;
            const cryptoField = document.getElementById('crypto-field');
            const fiiField = document.getElementById('fii-field');
            const stockField = document.getElementById('stock-field');
            const assetNameField = document.getElementById('asset-name-field');
            const quantityField = document.getElementById('quantity-field');
            const amountField = document.getElementById('amount-field');
            const rateField = document.getElementById('rate-field');
            const rateLabel = document.getElementById('rate-label');

            cryptoField.style.display = 'none';
            fiiField.style.display = 'none';
            stockField.style.display = 'none';
            assetNameField.style.display = 'none';
            quantityField.style.display = 'none';
            rateField.style.display = 'none';

            if (type === 'crypto') {
                cryptoField.style.display = 'block';
                quantityField.style.display = 'block';
                amountField.style.display = 'block';
            } else if (type === 'fii' || type === 'stock') {
                if (type === 'fii') fiiField.style.display = 'block';
                if (type === 'stock') stockField.style.display = 'block';
                quantityField.style.display = 'block';
                amountField.style.display = 'block';
            } else if (type === 'cdi') {
                assetNameField.style.display = 'block';
                amountField.style.display = 'block';
                rateField.style.display = 'block';
                rateLabel.textContent = '% do CDI';
                document.getElementById('interest-rate').placeholder = '100.00';
            } else if (type === 'fixed') {
                assetNameField.style.display = 'block';
                amountField.style.display = 'block';
                rateField.style.display = 'block';
                rateLabel.textContent = 'Taxa Anual (%)';
                document.getElementById('interest-rate').placeholder = '12.00';
            } else if (type === 'tesouro-selic') {
                assetNameField.style.display = 'block';
                amountField.style.display = 'block';
            } else if (type === 'tesouro-ipca') {
                assetNameField.style.display = 'block';
                amountField.style.display = 'block';
                rateField.style.display = 'block';
                rateLabel.textContent = 'Taxa Real (%)';
                document.getElementById('interest-rate').placeholder = '6.00';
            } else if (type === 'tesouro-prefixado') {
                assetNameField.style.display = 'block';
                amountField.style.display = 'block';
                rateField.style.display = 'block';
                rateLabel.textContent = 'Taxa Anual (%)';
                document.getElementById('interest-rate').placeholder = '11.50';
            }
        }

        async function addInvestment() {
            const portfolio = getActivePortfolio();
            if (!portfolio) return;

            const type = document.getElementById('asset-type').value;
            const date = document.getElementById('investment-date').value;
            const notes = document.getElementById('investment-notes').value;

            if (!date) {
                showToast('Preencha a data do aporte', 'error');
                return;
            }

            let holding = {
                id: Date.now().toString(),
                type: type,
                date: date,
                notes: notes
            };

            if (type === 'crypto') {
                const symbol = document.getElementById('crypto-symbol').value;
                const amount = parseFloat(document.getElementById('investment-amount').value) || 0;
                const quantity = parseFloat(document.getElementById('crypto-quantity').value) || 0;

                if (amount <= 0 && quantity <= 0) {
                    showToast('Informe o valor investido ou a quantidade', 'error');
                    return;
                }

                holding.symbol = symbol;
                holding.name = document.getElementById('crypto-symbol').selectedOptions[0].text;
                holding.invested = amount;
                holding.quantity = quantity;

                if (amount > 0 && quantity === 0) {
                    const price = await getCryptoPrice(symbol);
                    if (price > 0) {
                        holding.quantity = amount / price;
                    }
                } else if (quantity > 0 && amount === 0) {
                    const price = await getCryptoPrice(symbol);
                    holding.invested = quantity * price;
                }
            } else if (type === 'fii' || type === 'stock') {
                const ticker = type === 'fii' ? 
                    document.getElementById('fii-ticker').value.trim().toUpperCase() :
                    document.getElementById('stock-ticker').value.trim().toUpperCase();
                const amount = parseFloat(document.getElementById('investment-amount').value) || 0;
                const quantity = parseFloat(document.getElementById('crypto-quantity').value) || 0;

                if (!ticker) {
                    showToast('Informe o ticker do ativo', 'error');
                    return;
                }

                if (amount <= 0 && quantity <= 0) {
                    showToast('Informe o valor investido ou a quantidade', 'error');
                    return;
                }

                holding.ticker = ticker;
                holding.name = ticker;
                holding.invested = amount;
                holding.quantity = quantity;

                if (amount > 0 && quantity === 0) {
                    const price = await getStockPrice(ticker);
                    if (price > 0) {
                        holding.quantity = amount / price;
                    }
                } else if (quantity > 0 && amount === 0) {
                    const price = await getStockPrice(ticker);
                    holding.invested = quantity * price;
                }
            } else if (type === 'tesouro-selic') {
                const name = document.getElementById('asset-name').value.trim();
                const amount = parseFloat(document.getElementById('investment-amount').value) || 0;

                if (!name || amount <= 0) {
                    showToast('Preencha o nome e o valor investido', 'error');
                    return;
                }

                holding.name = name;
                holding.invested = amount;
            } else if (type === 'tesouro-ipca' || type === 'tesouro-prefixado') {
                const name = document.getElementById('asset-name').value.trim();
                const amount = parseFloat(document.getElementById('investment-amount').value) || 0;
                const rate = parseFloat(document.getElementById('interest-rate').value) || 0;

                if (!name || amount <= 0 || rate <= 0) {
                    showToast('Preencha todos os campos obrigatórios', 'error');
                    return;
                }

                holding.name = name;
                holding.invested = amount;
                holding.rate = rate;
            } else {
                const name = document.getElementById('asset-name').value.trim();
                const amount = parseFloat(document.getElementById('investment-amount').value) || 0;
                const rate = parseFloat(document.getElementById('interest-rate').value) || 0;

                if (!name || amount <= 0 || rate <= 0) {
                    showToast('Preencha todos os campos obrigatórios', 'error');
                    return;
                }

                holding.name = name;
                holding.invested = amount;
                holding.rate = rate;
            }

            portfolio.holdings.push(holding);
            saveData();
            showToast('Investimento adicionado!', 'success');
            
            document.getElementById('investment-amount').value = '';
            document.getElementById('crypto-quantity').value = '';
            document.getElementById('asset-name').value = '';
            document.getElementById('interest-rate').value = '';
            document.getElementById('fii-ticker').value = '';
            document.getElementById('stock-ticker').value = '';
            document.getElementById('investment-notes').value = '';

            renderHoldings();
            updateDashboard();
        }

        async function getStockPrice(ticker) {
            try {
                const response = await fetch(`https://brapi.dev/api/quote/${ticker}?range=1d`);
                const data = await response.json();
                if (data.results && data.results[0] && data.results[0].regularMarketPrice) {
                    return parseFloat(data.results[0].regularMarketPrice);
                }
            } catch (e) {
                console.error('Erro ao buscar preço da ação/FII:', e);
            }
            return 0;
        }

        async function getCryptoPrice(symbol) {
            if (state.cryptoPrices[symbol]) {
                return state.cryptoPrices[symbol];
            }

            try {
                const response = await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${symbol}&vs_currencies=brl`);
                const data = await response.json();
                const price = data[symbol]?.brl || 0;
                state.cryptoPrices[symbol] = price;
                return price;
            } catch (e) {
                console.error('Erro ao buscar preço:', e);
                return 0;
            }
        }

        async function loadIPCAHistory() {
            try {
                const endDate = new Date();
                const startDate = new Date();
                startDate.setFullYear(startDate.getFullYear() - 25);
                
                const startStr = `${startDate.getDate().toString().padStart(2, '0')}/${(startDate.getMonth() + 1).toString().padStart(2, '0')}/${startDate.getFullYear()}`;
                const endStr = `${endDate.getDate().toString().padStart(2, '0')}/${(endDate.getMonth() + 1).toString().padStart(2, '0')}/${endDate.getFullYear()}`;
                
                const response = await fetch(`https://api.bcb.gov.br/dados/serie/bcdata.sgs.433/dados?formato=json&dataInicial=${startStr}&dataFinal=${endStr}`);
                const data = await response.json();
                
                if (data && data.length > 0) {
                    state.ipcaHistory = data.map(item => ({
                        date: item.data,
                        value: parseFloat(item.valor)
                    }));
                    
                    const sum = state.ipcaHistory.reduce((acc, item) => acc + item.value, 0);
                    const avg = sum / state.ipcaHistory.length;
                    state.rates.ipcaAvg25Years = avg;
                    
                    console.log(`IPCA médio 25 anos: ${avg.toFixed(2)}%`);
                }
            } catch (e) {
                console.error('Erro ao buscar histórico do IPCA:', e);
                state.rates.ipcaAvg25Years = 5.8;
            }
        }

        function calculateAccumulatedInflation(startDate) {
            if (!state.ipcaHistory || state.ipcaHistory.length === 0) {
                const monthsDiff = Math.floor((new Date() - new Date(startDate)) / (1000 * 60 * 60 * 24 * 30));
                const monthlyAvg = state.rates.ipcaAvg25Years / 12;
                let accumulated = 1;
                for (let i = 0; i < monthsDiff; i++) {
                    accumulated *= (1 + monthlyAvg / 100);
                }
                return accumulated - 1;
            }
            
            const start = new Date(startDate);
            let accumulated = 1;
            
            state.ipcaHistory.forEach(item => {
                const [day, month, year] = item.date.split('/');
                const itemDate = new Date(year, month - 1, day);
                
                if (itemDate >= start) {
                    accumulated *= (1 + item.value / 100);
                }
            });
            
            return accumulated - 1;
        }

        function getInflationAdjustedValue(value, startDate) {
            if (!state.inflationAdjusted) return value;
            
            const inflationRate = calculateAccumulatedInflation(startDate);
            return value / (1 + inflationRate);
        }

        function syncInflationCheckbox(source) {
            const dashboardCheckbox = document.getElementById('adjust-inflation-dashboard');
            const portfolioCheckbox = document.getElementById('adjust-inflation');
            
            if (source === 'dashboard' && dashboardCheckbox) {
                state.inflationAdjusted = dashboardCheckbox.checked;
                if (portfolioCheckbox) portfolioCheckbox.checked = dashboardCheckbox.checked;
            } else if (source === 'portfolio' && portfolioCheckbox) {
                state.inflationAdjusted = portfolioCheckbox.checked;
                if (dashboardCheckbox) dashboardCheckbox.checked = portfolioCheckbox.checked;
            }
            
            const indicator = document.getElementById('inflation-indicator');
            if (indicator) {
                indicator.style.display = state.inflationAdjusted ? 'block' : 'none';
            }
            
            const avgDisplay = document.getElementById('ipca-avg-display');
            if (avgDisplay && state.rates.ipcaAvg25Years) {
                avgDisplay.textContent = state.rates.ipcaAvg25Years.toFixed(2) + '%';
            }
            
            renderHoldings();
            updateDashboard();
        }

        function toggleInflationAdjustment() {
            syncInflationCheckbox('portfolio');
        }

        async function getCDIRate() {
            try {
                const response = await fetch('https://api.bcb.gov.br/dados/serie/bcdata.sgs.4389/dados/ultimos/1?formato=json');
                const data = await response.json();
                if (data && data.length > 0) {
                    state.rates.cdi = parseFloat(data[0].valor);
                }
            } catch (e) {
                console.error('Erro ao buscar CDI:', e);
            }
        }

        async function updatePrices() {
            const cryptoIds = [
                'bitcoin', 'ethereum', 'solana', 'binancecoin', 'cardano',
                'ripple', 'dogecoin', 'polkadot', 'avalanche-2', 'chainlink'
            ];

            try {
                const response = await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${cryptoIds.join(',')}&vs_currencies=brl&include_24hr_change=true`);
                const data = await response.json();

                cryptoIds.forEach(id => {
                    if (data[id]) {
                        const priceEl = document.getElementById(`price-${id}`);
                        const changeEl = document.getElementById(`change-${id}`);
                        
                        if (priceEl) {
                            priceEl.textContent = formatCurrency(data[id].brl);
                        }
                        
                        if (changeEl && data[id].brl_24h_change !== undefined) {
                            const change = data[id].brl_24h_change;
                            changeEl.textContent = `${change >= 0 ? '+' : ''}${change.toFixed(2)}% (24h)`;
                            changeEl.className = change >= 0 ? 'stat-change positive' : 'stat-change negative';
                        }
                    }
                });
            } catch (e) {
                console.error('Erro ao buscar preços de cripto:', e);
            }

            try {
                const currencyResponse = await fetch('https://economia.awesomeapi.com.br/json/last/USD-BRL,EUR-BRL');
                const currencyData = await currencyResponse.json();
                
                if (currencyData.USDBRL) {
                    const usdEl = document.getElementById('usd-brl-value');
                    const usdChangeEl = document.getElementById('usd-brl-change');
                    if (usdEl) {
                        usdEl.textContent = `R$ ${parseFloat(currencyData.USDBRL.bid).toFixed(2)}`;
                    }
                    if (usdChangeEl) {
                        const change = parseFloat(currencyData.USDBRL.pctChange);
                        usdChangeEl.textContent = `${change >= 0 ? '+' : ''}${change.toFixed(2)}% hoje`;
                        usdChangeEl.className = change >= 0 ? 'stat-change positive' : 'stat-change negative';
                    }
                }

                if (currencyData.EURBRL) {
                    const eurEl = document.getElementById('eur-brl-value');
                    const eurChangeEl = document.getElementById('eur-brl-change');
                    if (eurEl) {
                        eurEl.textContent = `R$ ${parseFloat(currencyData.EURBRL.bid).toFixed(2)}`;
                    }
                    if (eurChangeEl) {
                        const change = parseFloat(currencyData.EURBRL.pctChange);
                        eurChangeEl.textContent = `${change >= 0 ? '+' : ''}${change.toFixed(2)}% hoje`;
                        eurChangeEl.className = change >= 0 ? 'stat-change positive' : 'stat-change negative';
                    }
                }
            } catch (e) {
                console.error('Erro ao buscar câmbio:', e);
            }

            const indices = [
                {symbol: '%5EBVSP', name: 'ibov', decimals: 0},
                {symbol: '%5EGSPC', name: 'sp500', decimals: 2},
                {symbol: '%5EIXIC', name: 'nasdaq', decimals: 2}
            ];

            for (const index of indices) {
                try {
                    const response = await fetch(`https://query1.finance.yahoo.com/v8/finance/chart/${index.symbol}?interval=1d&range=1d`, {
                        headers: {
                            'User-Agent': 'Mozilla/5.0'
                        }
                    });
                    const data = await response.json();
                    
                    if (data && data.chart && data.chart.result && data.chart.result[0]) {
                        const result = data.chart.result[0];
                        const meta = result.meta;
                        
                        const valueEl = document.getElementById(`${index.name}-value`);
                        const changeEl = document.getElementById(`${index.name}-change`);
                        
                        if (valueEl && meta.regularMarketPrice) {
                            if (index.decimals === 0) {
                                valueEl.textContent = parseFloat(meta.regularMarketPrice).toLocaleString('pt-BR', {
                                    minimumFractionDigits: 0,
                                    maximumFractionDigits: 0
                                });
                            } else {
                                valueEl.textContent = parseFloat(meta.regularMarketPrice).toLocaleString('en-US', {
                                    minimumFractionDigits: index.decimals,
                                    maximumFractionDigits: index.decimals
                                });
                            }
                        }
                        
                        if (changeEl && meta.regularMarketPrice && meta.previousClose) {
                            const change = ((meta.regularMarketPrice - meta.previousClose) / meta.previousClose) * 100;
                            changeEl.textContent = `${change >= 0 ? '+' : ''}${change.toFixed(2)}% hoje`;
                            changeEl.className = change >= 0 ? 'stat-change positive' : 'stat-change negative';
                        }
                    }
                } catch (e) {
                    console.error(`Erro ao buscar ${index.name}:`, e);
                    
                    try {
                        const brapiResponse = await fetch(`https://brapi.dev/api/quote/${index.symbol.replace('%5E', '%5E')}?range=1d&interval=1d`);
                        const brapiData = await brapiResponse.json();
                        
                        if (brapiData && brapiData.results && brapiData.results[0]) {
                            const stock = brapiData.results[0];
                            const valueEl = document.getElementById(`${index.name}-value`);
                            const changeEl = document.getElementById(`${index.name}-change`);
                            
                            if (valueEl && stock.regularMarketPrice) {
                                if (index.decimals === 0) {
                                    valueEl.textContent = parseFloat(stock.regularMarketPrice).toLocaleString('pt-BR', {
                                        minimumFractionDigits: 0,
                                        maximumFractionDigits: 0
                                    });
                                } else {
                                    valueEl.textContent = parseFloat(stock.regularMarketPrice).toLocaleString('en-US', {
                                        minimumFractionDigits: index.decimals,
                                        maximumFractionDigits: index.decimals
                                    });
                                }
                            }
                            
                            if (changeEl && stock.regularMarketChangePercent !== undefined) {
                                const change = stock.regularMarketChangePercent;
                                changeEl.textContent = `${change >= 0 ? '+' : ''}${change.toFixed(2)}% hoje`;
                                changeEl.className = change >= 0 ? 'stat-change positive' : 'stat-change negative';
                            }
                        }
                    } catch (fallbackError) {
                        console.error(`Fallback error para ${index.name}:`, fallbackError);
                    }
                }
            }

            try {
                const selicResponse = await fetch('https://api.bcb.gov.br/dados/serie/bcdata.sgs.11/dados/ultimos/1?formato=json');
                const selicData = await selicResponse.json();
                if (selicData && selicData.length > 0) {
                    const selicEl = document.getElementById('selic-rate');
                    if (selicEl) {
                        selicEl.textContent = parseFloat(selicData[0].valor).toFixed(2) + '%';
                    }
                }
            } catch (e) {
                console.error('Erro ao buscar Selic:', e);
            }

            try {
                const cdiResponse = await fetch('https://api.bcb.gov.br/dados/serie/bcdata.sgs.4389/dados/ultimos/1?formato=json');
                const cdiData = await cdiResponse.json();
                if (cdiData && cdiData.length > 0) {
                    const cdiEl = document.getElementById('cdi-rate');
                    if (cdiEl) {
                        cdiEl.textContent = parseFloat(cdiData[0].valor).toFixed(2) + '%';
                    }
                    state.rates.cdi = parseFloat(cdiData[0].valor);
                }
            } catch (e) {
                console.error('Erro ao buscar CDI:', e);
            }

            try {
                const ipcaResponse = await fetch('https://api.bcb.gov.br/dados/serie/bcdata.sgs.433/dados/ultimos/1?formato=json');
                const ipcaData = await ipcaResponse.json();
                if (ipcaData && ipcaData.length > 0) {
                    const ipcaEl = document.getElementById('ipca-rate');
                    if (ipcaEl) {
                        ipcaEl.textContent = parseFloat(ipcaData[0].valor).toFixed(2) + '%';
                    }
                    state.rates.ipca = parseFloat(ipcaData[0].valor);
                }
            } catch (e) {
                console.error('Erro ao buscar IPCA:', e);
            }

            const fiis = ['MXRF11', 'HGRE11', 'BTLG11', 'VISC11', 'KNRI11', 'XPML11'];
            for (const fii of fiis) {
                try {
                    const response = await fetch(`https://brapi.dev/api/quote/${fii}?range=1d`);
                    const data = await response.json();
                    
                    if (data.results && data.results[0]) {
                        const stock = data.results[0];
                        const priceEl = document.getElementById(`price-${fii.toLowerCase()}`);
                        const changeEl = document.getElementById(`change-${fii.toLowerCase()}`);
                        
                        if (priceEl && stock.regularMarketPrice) {
                            priceEl.textContent = formatCurrency(stock.regularMarketPrice);
                            state.stockPrices[fii] = stock.regularMarketPrice;
                        }
                        
                        if (changeEl && stock.regularMarketChangePercent !== undefined) {
                            const change = stock.regularMarketChangePercent;
                            changeEl.textContent = `${change >= 0 ? '+' : ''}${change.toFixed(2)}% hoje`;
                            changeEl.className = change >= 0 ? 'stat-change positive' : 'stat-change negative';
                        }
                    }
                } catch (e) {
                    console.error(`Erro ao buscar ${fii}:`, e);
                }
            }

            try {
                const tesouroResponse = await fetch('https://www.tesourotransparente.gov.br/ckan/api/3/action/datastore_search?resource_id=796d2059-14e9-44e3-80c9-2d9e30b405c1&limit=5');
                const tesouroData = await tesouroResponse.json();
                
                if (tesouroData.success && tesouroData.result && tesouroData.result.records) {
                    const records = tesouroData.result.records;
                    
                    const selic = records.find(r => r.tipo_titulo && r.tipo_titulo.includes('Selic'));
                    if (selic) {
                        const selicEl = document.getElementById('tesouro-selic-value');
                        const selicRateEl = document.getElementById('tesouro-selic-rate');
                        if (selicEl) selicEl.textContent = formatCurrency(parseFloat(selic.preco_compra || 0));
                        if (selicRateEl) selicRateEl.textContent = `Selic + 0%`;
                    }
                    
                    const ipca = records.find(r => r.tipo_titulo && r.tipo_titulo.includes('IPCA'));
                    if (ipca) {
                        const ipcaEl = document.getElementById('tesouro-ipca-value');
                        const ipcaRateEl = document.getElementById('tesouro-ipca-rate');
                        if (ipcaEl) ipcaEl.textContent = formatCurrency(parseFloat(ipca.preco_compra || 0));
                        if (ipcaRateEl && ipca.taxa_compra) ipcaRateEl.textContent = `IPCA + ${parseFloat(ipca.taxa_compra).toFixed(2)}%`;
                    }
                    
                    const prefixado = records.find(r => r.tipo_titulo && r.tipo_titulo.includes('Prefixado') && !r.tipo_titulo.includes('Juros'));
                    if (prefixado) {
                        const prefEl = document.getElementById('tesouro-prefixado-value');
                        const prefRateEl = document.getElementById('tesouro-prefixado-rate');
                        if (prefEl) prefEl.textContent = formatCurrency(parseFloat(prefixado.preco_compra || 0));
                        if (prefRateEl && prefixado.taxa_compra) prefRateEl.textContent = `${parseFloat(prefixado.taxa_compra).toFixed(2)}% a.a.`;
                    }
                }
            } catch (e) {
                console.error('Erro ao buscar Tesouro Direto:', e);
            }

            showToast('Preços atualizados!', 'success');
        }

        function calculateCurrentValue(holding) {
            const daysSince = Math.floor((new Date() - new Date(holding.date)) / (1000 * 60 * 60 * 24));
            
            if (holding.type === 'crypto') {
                const price = state.cryptoPrices[holding.symbol] || 0;
                return holding.quantity * price;
            } else if (holding.type === 'fii' || holding.type === 'stock') {
                const price = state.stockPrices[holding.ticker] || 0;
                if (price > 0) {
                    return holding.quantity * price;
                }
                return holding.invested;
            } else if (holding.type === 'cdi') {
                const rate = (state.rates.cdi * holding.rate / 100) / 100;
                const dailyRate = Math.pow(1 + rate, 1/252) - 1;
                return holding.invested * Math.pow(1 + dailyRate, daysSince);
            } else if (holding.type === 'tesouro-selic') {
                const rate = state.rates.selic / 100 || state.rates.cdi / 100;
                const dailyRate = Math.pow(1 + rate, 1/252) - 1;
                return holding.invested * Math.pow(1 + dailyRate, daysSince);
            } else if (holding.type === 'tesouro-ipca') {
                const ipca = state.rates.ipca || 4.5;
                const totalRate = ((holding.rate + ipca) / 100);
                const dailyRate = Math.pow(1 + totalRate, 1/252) - 1;
                return holding.invested * Math.pow(1 + dailyRate, daysSince);
            } else if (holding.type === 'tesouro-prefixado' || holding.type === 'fixed') {
                const rate = holding.rate / 100;
                const dailyRate = Math.pow(1 + rate, 1/252) - 1;
                return holding.invested * Math.pow(1 + dailyRate, daysSince);
            }
            return holding.invested;
        }

        async function renderHoldings() {
            const portfolio = getActivePortfolio();
            if (!portfolio) return;

            const container = document.getElementById('holdings-table');

            if (portfolio.holdings.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon"></div>
                        <p>Nenhum investimento cadastrado ainda.</p>
                        <p>Adicione seu primeiro investimento acima!</p>
                    </div>
                `;
                return;
            }

            const cryptoSymbols = [...new Set(portfolio.holdings.filter(h => h.type === 'crypto').map(h => h.symbol))];
            if (cryptoSymbols.length > 0) {
                await Promise.all(cryptoSymbols.map(s => getCryptoPrice(s)));
            }

            const stockTickers = [...new Set(portfolio.holdings.filter(h => h.type === 'fii' || h.type === 'stock').map(h => h.ticker))];
            if (stockTickers.length > 0) {
                await Promise.all(stockTickers.map(async t => {
                    const price = await getStockPrice(t);
                    state.stockPrices[t] = price;
                }));
            }

            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>Ativo</th>
                            <th>Tipo</th>
                            <th>Data</th>
                            <th>Investido</th>
                            <th>Atual</th>
                            <th>Alocação %</th>
                            <th>L/P</th>
                            <th>%</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            const totalValue = portfolio.holdings.reduce((sum, h) => sum + calculateCurrentValue(h), 0);
            const totalValueAdjusted = state.inflationAdjusted ? 
                portfolio.holdings.reduce((sum, h) => sum + getInflationAdjustedValue(calculateCurrentValue(h), h.date), 0) : 
                totalValue;

            portfolio.holdings.forEach(h => {
                const current = calculateCurrentValue(h);
                const currentAdjusted = getInflationAdjustedValue(current, h.date);
                const investedAdjusted = getInflationAdjustedValue(h.invested, h.date);
                
                const displayCurrent = state.inflationAdjusted ? currentAdjusted : current;
                const displayInvested = state.inflationAdjusted ? investedAdjusted : h.invested;
                
                const pl = displayCurrent - displayInvested;
                const plPercent = (pl / displayInvested) * 100;
                const allocation = totalValueAdjusted > 0 ? (displayCurrent / totalValueAdjusted) * 100 : 0;

                let badge = '';
                if (h.type === 'crypto') badge = '<span class="asset-type-badge crypto">CRIPTO</span>';
                else if (h.type === 'cdi') badge = '<span class="asset-type-badge cdi">CDI</span>';
                else if (h.type === 'fixed') badge = '<span class="asset-type-badge fixed">PREFIXADO</span>';
                else if (h.type === 'fii') badge = '<span class="asset-type-badge" style="background: rgba(255, 165, 0, 0.2); color: #ffa500; border: 1px solid #ffa500;">FII</span>';
                else if (h.type === 'stock') badge = '<span class="asset-type-badge" style="background: rgba(0, 255, 255, 0.2); color: #00ffff; border: 1px solid #00ffff;">AÇÃO</span>';
                else if (h.type === 'tesouro-selic') badge = '<span class="asset-type-badge" style="background: rgba(0, 255, 136, 0.2); color: #00ff88; border: 1px solid #00ff88;">TD SELIC</span>';
                else if (h.type === 'tesouro-ipca') badge = '<span class="asset-type-badge" style="background: rgba(0, 255, 136, 0.2); color: #00ff88; border: 1px solid #00ff88;">TD IPCA+</span>';
                else if (h.type === 'tesouro-prefixado') badge = '<span class="asset-type-badge" style="background: rgba(0, 255, 136, 0.2); color: #00ff88; border: 1px solid #00ff88;">TD PREFIXADO</span>';

                html += `
                    <tr>
                        <td><strong>${h.name}</strong></td>
                        <td>${badge}</td>
                        <td>${new Date(h.date).toLocaleDateString('pt-BR')}</td>
                        <td>${formatCurrency(displayInvested)}</td>
                        <td>${formatCurrency(displayCurrent)}</td>
                        <td><strong>${allocation.toFixed(2)}%</strong></td>
                        <td style="color: ${pl >= 0 ? 'var(--success)' : 'var(--danger)'}">${formatCurrency(pl)}</td>
                        <td style="color: ${pl >= 0 ? 'var(--success)' : 'var(--danger)'}">${formatPercent(plPercent)}</td>
                        <td><button class="delete-btn" onclick="deleteHolding('${h.id}')">Excluir</button></td>
                    </tr>
                `;
            });

            html += `</tbody></table>`;
            container.innerHTML = html;
        }

        function deleteHolding(id) {
            if (!confirm('Deseja realmente excluir este investimento?')) return;

            const portfolio = getActivePortfolio();
            portfolio.holdings = portfolio.holdings.filter(h => h.id !== id);
            saveData();
            showToast('Investimento excluído', 'info');
            renderHoldings();
            updateDashboard();
        }

        async function updateDashboard() {
            const portfolio = getActivePortfolio();
            if (!portfolio) return;

            await getCDIRate();

            const cryptoSymbols = [...new Set(portfolio.holdings.filter(h => h.type === 'crypto').map(h => h.symbol))];
            if (cryptoSymbols.length > 0) {
                await Promise.all(cryptoSymbols.map(s => getCryptoPrice(s)));
            }

            let totalInvested = 0;
            let currentValue = 0;

            portfolio.holdings.forEach(h => {
                const current = calculateCurrentValue(h);
                const invested = h.invested;
                
                if (state.inflationAdjusted) {
                    totalInvested += getInflationAdjustedValue(invested, h.date);
                    currentValue += getInflationAdjustedValue(current, h.date);
                } else {
                    totalInvested += invested;
                    currentValue += current;
                }
            });

            const pl = currentValue - totalInvested;
            const plPercent = totalInvested > 0 ? (pl / totalInvested) * 100 : 0;

            document.getElementById('total-invested').textContent = formatCurrency(totalInvested);
            document.getElementById('current-value').textContent = formatCurrency(currentValue);
            document.getElementById('total-pl').textContent = formatCurrency(pl);
            
            const plPercentEl = document.getElementById('total-pl-percent');
            plPercentEl.textContent = formatPercent(plPercent);
            plPercentEl.className = pl >= 0 ? 'stat-change positive' : 'stat-change negative';

            document.getElementById('total-assets').textContent = portfolio.holdings.length;

            document.getElementById('dashboard-portfolio-name').textContent = portfolio.name;

            const holdingsDiv = document.getElementById('dashboard-holdings');
            if (portfolio.holdings.length === 0) {
                holdingsDiv.innerHTML = '<p style="color: var(--text-dim);">Nenhum investimento cadastrado</p>';
            } else {
                let html = '<table><thead><tr><th>Ativo</th><th>Tipo</th><th>Investido</th><th>Atual</th><th>L/P</th></tr></thead><tbody>';
                portfolio.holdings.forEach(h => {
                    const current = calculateCurrentValue(h);
                    const pl = current - h.invested;
                    let badge = '';
                    if (h.type === 'crypto') badge = '<span class="asset-type-badge crypto">CRIPTO</span>';
                    else if (h.type === 'cdi') badge = '<span class="asset-type-badge cdi">CDI</span>';
                    else if (h.type === 'fixed') badge = '<span class="asset-type-badge fixed">PREFIXADO</span>';
                    
                    html += `<tr>
                        <td><strong>${h.name}</strong></td>
                        <td>${badge}</td>
                        <td>${formatCurrency(h.invested)}</td>
                        <td>${formatCurrency(current)}</td>
                        <td style="color: ${pl >= 0 ? 'var(--success)' : 'var(--danger)'}">${formatCurrency(pl)}</td>
                    </tr>`;
                });
                html += '</tbody></table>';
                holdingsDiv.innerHTML = html;
            }

            updateAllocationChart(portfolio);
            updateEvolutionChart(portfolio);

            if (!portfolio.history) portfolio.history = [];
            const today = new Date().toISOString().split('T')[0];
            const lastSnapshot = portfolio.history[portfolio.history.length - 1];
            if (!lastSnapshot || lastSnapshot.date !== today) {
                portfolio.history.push({
                    date: today,
                    value: currentValue
                });
                if (portfolio.history.length > 365) {
                    portfolio.history = portfolio.history.slice(-365);
                }
                saveData();
            }
        }

        function updateAllocationChart(portfolio) {
            const ctx = document.getElementById('allocation-chart');
            if (!ctx) return;

            const allocation = {
                crypto: 0,
                cdi: 0,
                fixed: 0,
                fii: 0,
                stock: 0,
                tesouro: 0
            };

            portfolio.holdings.forEach(h => {
                const value = calculateCurrentValue(h);
                if (h.type === 'crypto') {
                    allocation.crypto += value;
                } else if (h.type === 'cdi') {
                    allocation.cdi += value;
                } else if (h.type === 'fixed') {
                    allocation.fixed += value;
                } else if (h.type === 'fii') {
                    allocation.fii += value;
                } else if (h.type === 'stock') {
                    allocation.stock += value;
                } else if (h.type.startsWith('tesouro')) {
                    allocation.tesouro += value;
                }
            });

            if (state.charts.allocation) {
                state.charts.allocation.destroy();
            }

            state.charts.allocation = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Criptomoedas', 'CDI', 'Renda Fixa', 'FIIs', 'Ações', 'Tesouro Direto'],
                    datasets: [{
                        data: [allocation.crypto, allocation.cdi, allocation.fixed, allocation.fii, allocation.stock, allocation.tesouro],
                        backgroundColor: ['#ffea00', '#00f2ff', '#00ff88', '#ffa500', '#00ffff', '#88ff00'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#ffffff',
                                font: { size: 12 }
                            }
                        }
                    }
                }
            });
        }

        function updateEvolutionChart(portfolio) {
            const ctx = document.getElementById('evolution-chart');
            if (!ctx) return;

            const history = portfolio.history || [];
            const labels = history.map(h => new Date(h.date).toLocaleDateString('pt-BR'));
            const data = history.map(h => h.value);

            if (state.charts.evolution) {
                state.charts.evolution.destroy();
            }

            state.charts.evolution = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Patrimônio',
                        data: data,
                        borderColor: '#00f2ff',
                        backgroundColor: 'rgba(0, 242, 255, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#ffffff',
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#ffffff',
                                maxTicksLimit: 10
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });
        }

        function runSimulation() {
            const initial = parseFloat(document.getElementById('sim-initial').value) || 0;
            const monthly = parseFloat(document.getElementById('sim-monthly').value) || 0;
            const rate = parseFloat(document.getElementById('sim-rate').value) || 0;
            const years = parseInt(document.getElementById('sim-years').value) || 0;
            const adjustInflation = document.getElementById('adjust-inflation-simulator').checked;

            if (initial <= 0 || rate <= 0 || years <= 0) {
                showToast('Preencha todos os campos', 'error');
                return;
            }

            const months = years * 12;
            const monthlyRate = rate / 100 / 12;

            let balance = initial;
            const chartData = [initial];
            const chartDataReal = [initial];

            for (let i = 0; i < months; i++) {
                balance = balance * (1 + monthlyRate) + monthly;
                chartData.push(balance);
            }

            const totalInvested = initial + (monthly * months);
            const earnings = balance - totalInvested;

            let balanceReal = balance;
            let totalInvestedReal = totalInvested;
            let earningsReal = earnings;

            if (adjustInflation) {
                const monthlyInflation = state.rates.ipcaAvg25Years / 100 / 12;
                let inflationFactor = 1;
                
                for (let i = 0; i < months; i++) {
                    inflationFactor *= (1 + monthlyInflation);
                }
                
                balanceReal = balance / inflationFactor;
                totalInvestedReal = totalInvested / inflationFactor;
                earningsReal = balanceReal - totalInvestedReal;

                let tempBalance = initial;
                let tempInflation = 1;
                chartDataReal.push(tempBalance);
                
                for (let i = 0; i < months; i++) {
                    tempInflation *= (1 + monthlyInflation);
                    tempBalance = tempBalance * (1 + monthlyRate) + monthly;
                    chartDataReal.push(tempBalance / tempInflation);
                }
            }

            document.getElementById('sim-total-invested').textContent = formatCurrency(adjustInflation ? totalInvestedReal : totalInvested);
            document.getElementById('sim-earnings').textContent = formatCurrency(adjustInflation ? earningsReal : earnings);
            document.getElementById('sim-final').textContent = formatCurrency(adjustInflation ? balanceReal : balance);

            const resultDiv = document.getElementById('simulation-result');
            resultDiv.style.display = 'block';

            if (adjustInflation) {
                let inflationWarning = document.getElementById('sim-inflation-warning');
                if (!inflationWarning) {
                    inflationWarning = document.createElement('div');
                    inflationWarning.id = 'sim-inflation-warning';
                    inflationWarning.style.cssText = 'background: rgba(255, 234, 0, 0.1); border: 1px solid var(--accent); border-radius: 12px; padding: 15px; margin-top: 15px;';
                    inflationWarning.innerHTML = `
                        <p style="margin: 0; color: var(--accent); font-weight: 600; font-size: 13px;">
                            ⚠️ Valores ajustados pela inflação (IPCA ${state.rates.ipcaAvg25Years.toFixed(2)}% a.a.) | Poder de compra em valores de hoje
                        </p>
                        <p style="margin: 8px 0 0 0; color: var(--text-dim); font-size: 12px;">
                            Valor nominal: ${formatCurrency(balance)} | Valor real: ${formatCurrency(balanceReal)}
                        </p>
                    `;
                    resultDiv.insertBefore(inflationWarning, resultDiv.firstChild);
                } else {
                    inflationWarning.innerHTML = `
                        <p style="margin: 0; color: var(--accent); font-weight: 600; font-size: 13px;">
                            ⚠️ Valores ajustados pela inflação (IPCA ${state.rates.ipcaAvg25Years.toFixed(2)}% a.a.) | Poder de compra em valores de hoje
                        </p>
                        <p style="margin: 8px 0 0 0; color: var(--text-dim); font-size: 12px;">
                            Valor nominal: ${formatCurrency(balance)} | Valor real: ${formatCurrency(balanceReal)}
                        </p>
                    `;
                }
            } else {
                const inflationWarning = document.getElementById('sim-inflation-warning');
                if (inflationWarning) {
                    inflationWarning.remove();
                }
            }

            const ctx = document.getElementById('simulation-chart');
            if (state.charts.simulation) {
                state.charts.simulation.destroy();
            }

            const labels = Array.from({length: months + 1}, (_, i) => `Mês ${i}`);

            const datasets = [{
                label: adjustInflation ? 'Montante Real' : 'Montante',
                data: adjustInflation ? chartDataReal : chartData,
                borderColor: adjustInflation ? '#ffea00' : '#00f2ff',
                backgroundColor: adjustInflation ? 'rgba(255, 234, 0, 0.1)' : 'rgba(0, 242, 255, 0.1)',
                tension: 0.4,
                fill: true
            }];

            if (adjustInflation) {
                datasets.push({
                    label: 'Montante Nominal',
                    data: chartData,
                    borderColor: 'rgba(0, 242, 255, 0.3)',
                    backgroundColor: 'rgba(0, 242, 255, 0.05)',
                    tension: 0.4,
                    fill: false,
                    borderDash: [5, 5]
                });
            }

            state.charts.simulation = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            display: adjustInflation,
                            labels: {
                                color: '#ffffff',
                                font: { size: 12 }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#ffffff',
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        x: {
                            ticks: {
                                color: '#ffffff',
                                maxTicksLimit: 12
                            },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    }
                }
            });
        }

        function calculateCompound() {
            const principal = parseFloat(document.getElementById('calc-principal').value) || 0;
            const monthly = parseFloat(document.getElementById('calc-monthly').value) || 0;
            const rate = parseFloat(document.getElementById('calc-rate').value) || 0;
            const months = parseInt(document.getElementById('calc-months').value) || 0;
            const compound = document.getElementById('calc-compound').value;
            const adjustInflation = document.getElementById('adjust-inflation-calculator').checked;

            if (principal <= 0 || rate <= 0 || months <= 0) {
                showToast('Preencha todos os campos', 'error');
                return;
            }

            const periods = compound === 'daily' ? months * 30 : months;
            const periodRate = compound === 'daily' ? rate / 100 / 360 : rate / 100 / 12;

            let balance = principal;
            const chartData = [principal];
            const chartDataReal = [principal];

            for (let i = 0; i < periods; i++) {
                balance = balance * (1 + periodRate);
                if (compound === 'monthly' || (compound === 'daily' && (i + 1) % 30 === 0)) {
                    balance += monthly;
                }
                chartData.push(balance);
            }

            const totalInvested = principal + (monthly * months);
            const interest = balance - totalInvested;
            const returnPercent = (interest / totalInvested) * 100;

            let balanceReal = balance;
            let totalInvestedReal = totalInvested;
            let interestReal = interest;
            let returnPercentReal = returnPercent;

            if (adjustInflation) {
                const monthlyInflation = state.rates.ipcaAvg25Years / 100 / 12;
                let inflationFactor = 1;
                
                for (let i = 0; i < months; i++) {
                    inflationFactor *= (1 + monthlyInflation);
                }
                
                balanceReal = balance / inflationFactor;
                totalInvestedReal = totalInvested / inflationFactor;
                interestReal = balanceReal - totalInvestedReal;
                returnPercentReal = (interestReal / totalInvestedReal) * 100;

                let tempBalance = principal;
                let tempInflation = 1;
                chartDataReal.push(tempBalance);
                
                for (let i = 0; i < periods; i++) {
                    tempBalance = tempBalance * (1 + periodRate);
                    if (compound === 'monthly' || (compound === 'daily' && (i + 1) % 30 === 0)) {
                        tempBalance += monthly;
                        tempInflation *= (1 + monthlyInflation);
                    }
                    chartDataReal.push(tempBalance / tempInflation);
                }
            }

            document.getElementById('calc-total-invested').textContent = formatCurrency(adjustInflation ? totalInvestedReal : totalInvested);
            document.getElementById('calc-interest').textContent = formatCurrency(adjustInflation ? interestReal : interest);
            document.getElementById('calc-final').textContent = formatCurrency(adjustInflation ? balanceReal : balance);
            document.getElementById('calc-return').textContent = formatPercent(adjustInflation ? returnPercentReal : returnPercent);

            const resultDiv = document.getElementById('calculator-result');
            resultDiv.style.display = 'block';

            if (adjustInflation) {
                let inflationWarning = document.getElementById('calc-inflation-warning');
                if (!inflationWarning) {
                    inflationWarning = document.createElement('div');
                    inflationWarning.id = 'calc-inflation-warning';
                    inflationWarning.style.cssText = 'background: rgba(255, 234, 0, 0.1); border: 1px solid var(--accent); border-radius: 12px; padding: 15px; margin-top: 15px;';
                    inflationWarning.innerHTML = `
                        <p style="margin: 0; color: var(--accent); font-weight: 600; font-size: 13px;">
                            ⚠️ Valores ajustados pela inflação (IPCA ${state.rates.ipcaAvg25Years.toFixed(2)}% a.a.) | Poder de compra em valores de hoje
                        </p>
                        <p style="margin: 8px 0 0 0; color: var(--text-dim); font-size: 12px;">
                            Valor nominal: ${formatCurrency(balance)} | Valor real: ${formatCurrency(balanceReal)}
                        </p>
                    `;
                    resultDiv.insertBefore(inflationWarning, resultDiv.firstChild);
                } else {
                    inflationWarning.innerHTML = `
                        <p style="margin: 0; color: var(--accent); font-weight: 600; font-size: 13px;">
                            ⚠️ Valores ajustados pela inflação (IPCA ${state.rates.ipcaAvg25Years.toFixed(2)}% a.a.) | Poder de compra em valores de hoje
                        </p>
                        <p style="margin: 8px 0 0 0; color: var(--text-dim); font-size: 12px;">
                            Valor nominal: ${formatCurrency(balance)} | Valor real: ${formatCurrency(balanceReal)}
                        </p>
                    `;
                }
            } else {
                const inflationWarning = document.getElementById('calc-inflation-warning');
                if (inflationWarning) {
                    inflationWarning.remove();
                }
            }

            const ctx = document.getElementById('calculator-chart');
            if (state.charts.calculator) {
                state.charts.calculator.destroy();
            }

            const labels = Array.from({length: periods + 1}, (_, i) => 
                compound === 'daily' ? `Dia ${i}` : `Mês ${i}`
            );

            const datasets = [{
                label: adjustInflation ? 'Montante Real' : 'Montante',
                data: adjustInflation ? chartDataReal : chartData,
                borderColor: adjustInflation ? '#ffea00' : '#00ff88',
                backgroundColor: adjustInflation ? 'rgba(255, 234, 0, 0.1)' : 'rgba(0, 255, 136, 0.1)',
                tension: 0.4,
                fill: true
            }];

            if (adjustInflation) {
                datasets.push({
                    label: 'Montante Nominal',
                    data: chartData,
                    borderColor: 'rgba(0, 255, 136, 0.3)',
                    backgroundColor: 'rgba(0, 255, 136, 0.05)',
                    tension: 0.4,
                    fill: false,
                    borderDash: [5, 5]
                });
            }

            state.charts.calculator = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            display: adjustInflation,
                            labels: {
                                color: '#ffffff',
                                font: { size: 12 }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#ffffff',
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        x: {
                            ticks: {
                                color: '#ffffff',
                                maxTicksLimit: 12
                            },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    }
                }
            });
        }

        function exportPortfolio() {
            const portfolio = getActivePortfolio();
            if (!portfolio) return;

            const data = {
                version: '1.0',
                portfolio: portfolio,
                exportDate: new Date().toISOString()
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `wolfinance-${portfolio.name.replace(/\s+/g, '-')}-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);

            showToast('Carteira exportada com sucesso!', 'success');
        }

        function importPortfolio(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (!data.portfolio || !data.portfolio.name) {
                        showToast('Arquivo inválido', 'error');
                        return;
                    }

                    const existingIndex = state.portfolios.findIndex(p => p.id === data.portfolio.id);
                    if (existingIndex >= 0) {
                        if (confirm(`Carteira "${data.portfolio.name}" já existe. Deseja substituir?`)) {
                            state.portfolios[existingIndex] = data.portfolio;
                        } else {
                            data.portfolio.id = Date.now().toString();
                            data.portfolio.name += ' (Importada)';
                            state.portfolios.push(data.portfolio);
                        }
                    } else {
                        state.portfolios.push(data.portfolio);
                    }

                    state.activePortfolio = data.portfolio.id;
                    saveData();
                    updatePortfolioSelector();
                    showToast('Carteira importada com sucesso!', 'success');
                    updateDashboard();
                    renderHoldings();
                } catch (e) {
                    showToast('Erro ao importar arquivo: ' + e.message, 'error');
                }
            };
            reader.readAsText(file);
        }

        function confirmReset() {
            if (!confirm('Tem certeza que deseja resetar esta carteira? Esta ação não pode ser desfeita.')) return;
            
            const portfolio = getActivePortfolio();
            portfolio.holdings = [];
            portfolio.history = [];
            saveData();
            showToast('Carteira resetada', 'info');
            updateDashboard();
            renderHoldings();
        }

        function confirmClearAll() {
            if (!confirm('ATENÇÃO: Isso irá apagar TODAS as carteiras e dados. Tem certeza?')) return;
            if (!confirm('Última confirmação: Deseja realmente limpar tudo?')) return;
            
            localStorage.removeItem('wolfinance');
            state.portfolios = [];
            state.activePortfolio = null;
            
            const defaultPortfolio = {
                id: Date.now().toString(),
                name: 'Minha Carteira Principal',
                holdings: [],
                history: []
            };
            state.portfolios.push(defaultPortfolio);
            state.activePortfolio = defaultPortfolio.id;
            saveData();
            
            showToast('Todos os dados foram limpos', 'info');
            updatePortfolioSelector();
            updateDashboard();
            renderHoldings();
        }

        window.onload = function() {
            initParticles();
            loadData();
            updatePortfolioSelector();
            toggleAssetFields();
            
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('investment-date').value = today;
            
            loadIPCAHistory();
            
            updateDashboard();
            renderHoldings();
            updatePrices();

            setInterval(() => {
                if (document.getElementById('dashboard').classList.contains('active')) {
                    updateDashboard();
                }
                if (document.getElementById('portfolio').classList.contains('active')) {
                    renderHoldings();
                }
                if (document.getElementById('prices').classList.contains('active')) {
                    updatePrices();
                }
            }, 60000);
        };
    </script>
</body>
</html>